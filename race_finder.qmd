---
title: "Race finder"
image: img/profile.png
about:
  template: jolla
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}

library(dplyr)
library(DT)
library(arrow)
library(hms)

all_dirs <- list.dirs('./posts/race_reports', recursive = FALSE, full.names = FALSE)
all_dirs <- data.frame(
  blog_path = all_dirs
)


allRaces <- arrow::read_parquet('https://storage.googleapis.com/blogs_josa/sport/parquets/main_dataset.parquet') |>
  select(all_of(c("EVENT_DATE", "EVENT_NAME", "EVENT_TYPE", "EVENT_DISTANCE", "ID"))) |>
  mutate(Race_analysis = ifelse(EVENT_TYPE != "virtual", paste0('<a href="https://asjblog.shinyapps.io/single_race_viewer/?_inputs_&selector=%22',
                       gsub(" ", "%20", ID),
                       '%22" target="_blank">Link</a>'), '')#,
         # RESULT_FINAL = as.character(hms::as_hms(result_total)),
         # result_total = ifelse(result_total == "00:00:00", '', result_total)
         ) |>
  arrange(desc(EVENT_DATE)) |>
  mutate(blog_path = paste0(EVENT_DATE,'_',EVENT_NAME),
         blog_path = gsub(' ','_', blog_path)) |>
  left_join(all_dirs, by = 'blog_path') |>
  mutate(blog_path = ifelse(EVENT_TYPE != 'virtual', paste0(
    '<a href="posts/race_reports/',
    blog_path,
    '">Link</a>'
  ),
  paste0(
    '<a href="posts/others/',
    blog_path,
    '">Link</a>'
  ))) |>
  select(c('EVENT_DATE', 'EVENT_NAME',  'EVENT_TYPE', 'EVENT_DISTANCE', 'blog_path', 'Race_analysis',)) |>
  rename('Race type' = 'EVENT_TYPE',
         'Race name' = 'EVENT_NAME',
         'Race distance' = 'EVENT_DISTANCE',
         'Race date' = 'EVENT_DATE',
         'Race report' = 'blog_path',
         'Race analysis' = 'Race_analysis')

DT::datatable(allRaces,
              rownames = FALSE,
              filter = 'top',
              selection = 'single',
              escape = FALSE,
              options = list(
                paging =TRUE,
                pageLength =  10
              ))
```
